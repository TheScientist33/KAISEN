<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Preload</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.js"></script>
</head>
<body>
<script>
(async () => {
  try {
    const vision = await FilesetResolver.forVisionTasks(
      'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm'
    );
    await PoseLandmarker.createFromOptions(vision, {
      baseOptions: {
        modelAssetPath:
          'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task'
      },
      runningMode: 'IMAGE',
      numPoses: 1
    });
    parent.postMessage({ type: 'PRELOAD_READY' }, '*');
  } catch (e) {
    parent.postMessage({ type: 'PRELOAD_ERROR', error: String(e) }, '*');
  }

  window.addEventListener('message', async (evt) => {
    const data = evt.data || {};
    if (data.type === 'WARMUP_CAMERA') {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        stream.getTracks().forEach(t => t.stop());
        parent.postMessage({ type: 'CAM_PERMISSION_RESULT', granted: true }, '*');
      } catch (e) {
        parent.postMessage({ type: 'CAM_PERMISSION_RESULT', granted: false, error: String(e) }, '*');
      }
    }
  });
})();
</script>
</body>
</html>
